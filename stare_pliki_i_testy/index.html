<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centrum Dowodzenia Bota Margin</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #1a1a2e; /* Ciemne tło */
            color: #e0e0e0; /* Jasny tekst */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        .container {
            background-color: #16213e; /* Ciemniejszy panel */
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            width: 90%;
            max-width: 1200px;
            margin-top: 30px;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        header {
            text-align: center;
            margin-bottom: 25px;
            color: #0f3460; /* Głęboki niebieski dla nagłówka */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        header h1 {
            font-size: 2.2em;
            font-weight: 700;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            margin: 0;
        }

        .icon {
            font-size: 2.5em;
            color: #e94560; /* Czerwony akcent */
        }

        .status-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #0f3460;
            padding: 18px 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            flex-wrap: wrap; /* Umożliwia zawijanie się elementów */
            gap: 15px; /* Odstęp między elementami */
        }

        .status-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 1.1em;
            flex: 1 1 auto; /* Umożliwia rozciąganie/kurczenie */
            min-width: 120px; /* Minimalna szerokość, aby nie było za ciasno */
        }

        .status-label {
            color: #a0a0a0;
            margin-bottom: 5px;
            text-align: center;
        }

        .status-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #e0e0e0;
            text-align: center;
        }

        .status-value.in-position {
            color: #00ff00; /* Zielony */
        }

        .status-value.not-in-position {
            color: #ffcc00; /* Żółty */
        }

        .status-value.error {
            color: #ff3333; /* Czerwony */
        }

        .status-value.pnl-positive {
            color: #00ff00;
        }

        .status-value.pnl-negative {
            color: #ff3333;
        }
        .status-value.pnl-zero {
            color: #e0e0e0;
        }


        .tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid #0f3460;
            flex-wrap: wrap; /* Umożliwia zawijanie się zakładek */
        }

        .tab-button {
            background-color: #1a1a2e;
            color: #a0a0a0;
            padding: 12px 25px;
            border: none;
            cursor: pointer;
            font-size: 1.05em;
            transition: all 0.3s ease;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin-right: 5px;
            flex-grow: 1; /* Pozwala na rozciąganie zakładek */
            text-align: center;
        }

        .tab-button:hover {
            background-color: #0f3460;
            color: #e0e0e0;
        }

        .tab-button.active {
            background-color: #0f3460;
            color: #e94560;
            font-weight: 700;
            border-bottom: 2px solid #e94560;
        }

        .tab-content {
            background-color: #0f3460;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        h2 {
            color: #e94560;
            font-size: 1.8em;
            margin-bottom: 20px;
            border-bottom: 2px solid #1a1a2e;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap; /* Pozwala elementom zawijać się na mniejszych ekranach */
        }

        .form-label {
            flex: 0 0 200px; /* Stała szerokość dla etykiety */
            color: #a0a0a0;
            font-size: 1em;
            white-space: nowrap; /* Zapobiega łamaniu wierszy */
        }

        .form-field {
            flex: 1 1 250px; /* Pole zajmuje resztę miejsca */
            background-color: #1a1a2e;
            border: 1px solid #0f3460;
            border-radius: 5px;
            padding: 10px 15px;
            color: #e0e0e0;
            font-size: 1em;
            transition: border-color 0.3s ease;
            min-width: 150px; /* Minimalna szerokość pola */
        }

        .form-field:focus {
            border-color: #e94560;
            outline: none;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-checkbox {
            width: 18px;
            height: 18px;
            accent-color: #e94560;
        }

        select.form-field {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23e0e0e0'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 18px;
            cursor: pointer;
        }

        .button-group {
            margin-top: 30px;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-button {
            background-color: #e94560;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 700;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 10px rgba(233, 69, 96, 0.4);
        }

        .action-button:hover {
            background-color: #c93450;
            transform: translateY(-2px);
        }

        .action-button.secondary {
            background-color: #0f3460;
            box-shadow: 0 4px 10px rgba(15, 52, 96, 0.4);
        }

        .action-button.secondary:hover {
            background-color: #0c2b4d;
        }

        .position-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .detail-item {
            background-color: #1a1a2e;
            padding: 18px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .detail-label {
            color: #a0a0a0;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 1.3em;
            font-weight: 700;
            color: #e0e0e0;
        }
        .detail-value.positive { color: #00ff00; }
        .detail-value.negative { color: #ff3333; }

        .message-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 700;
            display: none; /* Domyślnie ukryte */
        }

        .message-box.success {
            background-color: #28a745;
            color: white;
        }

        .message-box.error {
            background-color: #dc3545;
            color: white;
        }

        .message-box.info {
            background-color: #007bff;
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background-color: #1a1a2e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .stat-label {
            color: #a0a0a0;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #e0e0e0;
        }
        .stat-value.positive { color: #00ff00; }
        .stat-value.negative { color: #ff3333; }
        .stat-value.zero { color: #e0e0e0; }

        /* Media Queries dla responsywności */
        @media (max-width: 768px) {
            .container {
                width: 95%;
                padding: 15px;
            }
            header h1 {
                font-size: 1.8em;
            }
            .icon {
                font-size: 2em;
            }
            .status-panel {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            .tab-button {
                padding: 10px 15px;
                font-size: 0.95em;
            }
            .form-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .form-label {
                flex: none;
                width: 100%;
            }
            .form-field {
                flex: none;
                width: 100%;
            }
            .button-group {
                justify-content: center;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <span class="icon">🤖</span>
            <h1>Centrum Dowodzenia Bota Margin</h1>
        </header>

        <div class="status-panel">
            <div class="status-item">
                <span class="status-label">Status Bota</span>
                <span id="bot-status" class="status-value not-in-position">Ładowanie...</span>
            </div>
            <div class="status-item">
                <span class="status-label">Aktualna Cena</span>
                <span id="current-price" class="status-value">--</span>
            </div>
            <div class="status-item">
                <span class="status-label">PnL Pozycji (%)</span>
                <span id="position-pnl-percent" class="status-value pnl-zero">--</span>
            </div>
            <div class="status-item">
                <span class="status-label">Dostępne Saldo ({{ config.quote_asset | default('USDT') }})</span>
                <span id="available-balance" class="status-value">--</span>
            </div>
            <div class="status-item">
                <span class="status-label">Czas UTC</span>
                <span id="utc-time" class="status-value">Ładowanie...</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'configuration')">⚙️ Konfiguracja</button>
            <button class="tab-button" onclick="openTab(event, 'current-position')">📈 Bieżąca Pozycja</button>
            <button class="tab-button" onclick="openTab(event, 'trade-stats')">📊 Statystyki Handlowe</button>
        </div>

        <div id="configuration" class="tab-content">
            <h2>Konfiguracja Bota</h2>
            <form id="config-form">
                <div class="form-group">
                    <label for="trade_symbol" class="form-label">Symbol Handlu:</label>
                    <select id="trade_symbol" name="trade_symbol" class="form-field"></select>
                    <input type="hidden" id="quote_asset_display" value="{{ config.quote_asset | default('USDC') }}">
                </div>
                <div class="form-group">
                    <label for="position_size_percent" class="form-label">Rozmiar Pozycji (% salda):</label>
                    <input type="number" id="position_size_percent" name="position_size_percent" class="form-field" value="{{ config.position_size_percent }}" step="0.1" min="0.1" max="100">
                </div>
                <div class="form-group">
                    <label for="min_position_value_usdc" class="form-label">Min. Wartość Pozycji (USDC):</label>
                    <input type="number" id="min_position_value_usdc" name="min_position_value_usdc" class="form-field" value="{{ config.min_position_value_usdc }}" step="1" min="1">
                </div>
                <div class="form-group">
                    <label for="max_balance_wait_time_seconds" class="form-label">Max. Czas Czekania na Saldo (s):</label>
                    <input type="number" id="max_balance_wait_time_seconds" name="max_balance_wait_time_seconds" class="form-field" value="{{ config.max_balance_wait_time_seconds }}" step="5" min="5">
                </div>
                <div class="form-group">
                    <label for="sl_percent" class="form-label">Stop Loss (%):</label>
                    <input type="number" id="sl_percent" name="sl_percent" class="form-field" value="{{ config.sl_percent }}" step="0.1" min="0" max="100">
                </div>
                <div class="form-group">
                    <label for="exit_strategy" class="form-label">Strategia Wyjścia:</label>
                    <select id="exit_strategy" name="exit_strategy" class="form-field">
                        <option value="take_profit" {% if config.exit_strategy == 'take_profit' %}selected{% endif %}>Take Profit</option>
                        <option value="trailing_stop" {% if config.exit_strategy == 'trailing_stop' %}selected{% endif %}>Trailing Stop</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tp_percent" class="form-label">TP Aktywacja (%):</label>
                    <input type="number" id="tp_percent" name="tp_percent" class="form-field" value="{{ config.tp_percent }}" step="0.1" min="0" max="100">
                </div>
                <div class="form-group">
                    <label for="ts_activation_percent" class="form-label">TS Aktywacja (%):</label>
                    <input type="number" id="ts_activation_percent" name="ts_activation_percent" class="form-field" value="{{ config.ts_activation_percent }}" step="0.1" min="0" max="100">
                </div>
                <div class="form-group">
                    <label for="ts_distance_percent" class="form-label">TS Dystans (%):</label>
                    <input type="number" id="ts_distance_percent" name="ts_distance_percent" class="form-field" value="{{ config.ts_distance_percent }}" step="0.1" min="0" max="100">
                </div>
                <div class="form-group">
                    <label class="form-label checkbox-group">
                        <input type="checkbox" id="reentry_enabled" name="reentry_enabled" class="form-checkbox" {% if config.reentry_enabled %}checked{% endif %}>
                        Ponowne Wejście (Re-entry)
                    </label>
                    <label for="reentry_max_count" class="form-label">Max. Ponownych Wejść:</label>
                    <input type="number" id="reentry_max_count" name="reentry_max_count" class="form-field" value="{{ config.reentry_max_count }}" step="1" min="0">
                </div>
                <div class="form-group">
                    <label for="reentry_cooldown_seconds" class="form-label">Cooldown Re-entry (s):</label>
                    <input type="number" id="reentry_cooldown_seconds" name="reentry_cooldown_seconds" class="form-field" value="{{ config.reentry_cooldown_seconds }}" step="10" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label checkbox-group">
                        <input type="checkbox" id="pyramid_enabled" name="pyramid_enabled" class="form-checkbox" {% if config.pyramid_enabled %}checked{% endif %}>
                        Piramidowanie
                    </label>
                    <label for="pyramid_trigger_percent" class="form-label">Próg Piramidowania (% zysku):</label>
                    <input type="number" id="pyramid_trigger_percent" name="pyramid_trigger_percent" class="form-field" value="{{ config.pyramid_trigger_percent }}" step="0.1" min="0" max="100">
                </div>
                <div class="form-group">
                    <label for="pyramid_step_percent" class="form-label">Krok Piramidowania (% salda):</label>
                    <input type="number" id="pyramid_step_percent" name="pyramid_step_percent" class="form-field" value="{{ config.pyramid_step_percent }}" step="0.1" min="0.1" max="100">
                </div>
                <div class="form-group">
                    <label for="pyramid_max_steps" class="form-label">Max. Kroków Piramidowania:</label>
                    <input type="number" id="pyramid_max_steps" name="pyramid_max_steps" class="form-field" value="{{ config.pyramid_max_steps }}" step="1" min="0">
                </div>

                <div class="button-group">
                    <button type="submit" class="action-button">Zapisz Konfigurację</button>
                </div>
                <div id="config-message" class="message-box" style="display: none;"></div>
            </form>
        </div>

        <div id="current-position" class="tab-content" style="display: none;">
            <h2>Bieżąca Pozycja</h2>
            <div class="position-details">
                <div class="detail-item">
                    <div class="detail-label">Status Pozycji</div>
                    <div id="current-position-status" class="detail-value">Brak pozycji</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Symbol</div>
                    <div id="position-symbol" class="detail-value">--</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Kierunek</div>
                    <div id="position-side" class="detail-value">--</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Ilość</div>
                    <div id="position-quantity" class="detail-value">--</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Cena Wejścia</div>
                    <div id="position-entry-price" class="detail-value">--</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Czas Wejścia</div>
                    <div id="position-entry-time" class="detail-value">--</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">PnL Wartość ({{ config.quote_asset | default('USDT') }})</div>
                    <div id="position-pnl-value" class="detail-value">--</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">PnL Procent (%)</div>
                    <div id="position-pnl-percent-detail" class="detail-value">--</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Liczba Ponownych Wejść</div>
                    <div id="position-reentry-count" class="detail-value">--</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Liczba Kroków Piramidowania</div>
                    <div id="position-pyramid-steps" class="detail-value">--</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Cooldown Re-entry</div>
                    <div id="position-reentry-cooldown" class="detail-value">--</div>
                </div>
            </div>
            <div class="button-group">
                <button id="close-position-button" class="action-button secondary">Zamknij Pozycję Awaryjnie</button>
            </div>
            <div id="close-position-message" class="message-box" style="display: none;"></div>
        </div>

        <div id="trade-stats" class="tab-content" style="display: none;">
            <h2>Statystyki Handlowe</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Całkowity PnL ({{ config.quote_asset | default('USDT') }})</div>
                    <div id="total-pnl" class="stat-value">0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Liczba Pozycji</div>
                    <div id="total-positions" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pozycje Zyskowne</div>
                    <div id="successful-positions" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Współczynnik Wygranych (%)</div>
                    <div id="win-rate" class="stat-value">0.00%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Średni PnL na Transakcję</div>
                    <div id="avg-pnl-per-trade" class="stat-value">0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Max. Zyskowna Transakcja</div>
                    <div id="max-profit-trade" class="stat-value">0.00</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Max. Stratna Transakcja</div>
                    <div id="max-loss-trade" class="stat-value">0.00</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let currentActiveTab = 'configuration'; // Domyślna aktywna zakładka

        function openTab(evt, tabName) {
            // Deklaracja zmiennych
            var i, tabcontent, tablinks;

            // Pobierz wszystkie elementy z klasą "tab-content" i ukryj je
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // Pobierz wszystkie elementy z klasą "tab-button" i usuń klasę "active"
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            // Pokaż aktualną zakładkę i dodaj klasę "active" do przycisku, który otworzył zakładkę
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            currentActiveTab = tabName; // Zaktualizuj aktywną zakładkę

            if (tabName === 'trade-stats') {
                updateStatsDisplay();
            }
        }

        // Domyślnie otwórz pierwszą zakładkę przy ładowaniu strony
        document.addEventListener("DOMContentLoaded", function() {
            document.querySelector(".tab-button").click();
            loadMarketData(); // Załaduj symbole do wyboru
            updateStatusDisplay(); // Odśwież status bota od razu
            updateStatsDisplay(); // Odśwież statystyki
            setInterval(updateStatusDisplay, 5000); // Odświeżaj status co 5 sekund
            setInterval(updateUTCTime, 1000); // Odświeżaj czas UTC co sekundę
        });

        function updateUTCTime() {
            const now = new Date();
            const utcTime = now.toUTCString().split(' ')[4]; // Pobierz tylko czas UTC
            document.getElementById('utc-time').textContent = utcTime;
        }

        async function loadMarketData() {
            try {
                const response = await fetch('/market_data');
                const data = await response.json();
                const symbolSelect = document.getElementById('trade_symbol');
                const currentSymbol = symbolSelect.value; // Zapisz aktualnie wybrany symbol

                symbolSelect.innerHTML = ''; // Wyczyść istniejące opcje

                data.usdc_pairs.forEach(symbol => {
                    const option = document.createElement('option');
                    option.value = symbol;
                    option.textContent = symbol;
                    symbolSelect.appendChild(option);
                });

                // Przywróć poprzednio wybrany symbol, jeśli nadal istnieje
                if ([...data.usdc_pairs].includes(currentSymbol)) {
                    symbolSelect.value = currentSymbol;
                } else {
                    // Jeśli domyślny symbol z config.json jest dostępny, wybierz go
                    const configSymbol = "{{ config.trade_symbol | default('BTCUSDC') }}";
                    if ([...data.usdc_pairs].includes(configSymbol)) {
                        symbolSelect.value = configSymbol;
                    }
                }
                // Wyświetl aktywo kwotujące (np. USDC) obok symbolu
                const selectedOption = symbolSelect.options[symbolSelect.selectedIndex];
                const quoteAsset = document.getElementById('quote_asset_display').value; // Pobierz z ukrytego inputa
                if (selectedOption) {
                    // Tutaj można by wyświetlić aktywo kwotujące obok symbolu, jeśli byłoby na to miejsce
                    // Na razie używamy tylko `config.quote_asset`
                }

            } catch (error) {
                console.error('Błąd ładowania danych rynkowych:', error);
                showMessage('config-message', 'error', 'Błąd ładowania symboli handlowych.');
            }
        }


        async function updateStatusDisplay() {
            try {
                const response = await fetch('/status');
                const data = await response.json();

                document.getElementById('bot-status').textContent = data.status_text;

                document.getElementById('available-balance').textContent = `${data.balance.toFixed(2)} ${data.quote_asset}`;

                const botStatusElement = document.getElementById('bot-status');
                botStatusElement.classList.remove('in-position', 'not-in-position', 'error');

                if (data.in_position) {
                    botStatusElement.classList.add('in-position');
                    document.getElementById('current-position-status').textContent = 'W pozycji';
                    document.getElementById('current-position-status').classList.remove('not-in-position');
                    document.getElementById('current-position-status').classList.add('in-position');

                    document.getElementById('position-symbol').textContent = data.state.symbol;
                    document.getElementById('position-side').textContent = data.state.side;
                    document.getElementById('position-quantity').textContent = data.state.quantity.toFixed(5);
                    document.getElementById('position-entry-price').textContent = data.state.entry_price.toFixed(4);
                    document.getElementById('position-entry-time').textContent = new Date(data.state.entry_timestamp).toLocaleString();
                    document.getElementById('position-reentry-count').textContent = `${data.state.reentry_count} / ${data.reentry_info.max_count}`;
                    document.getElementById('position-pyramid-steps').textContent = data.state.pyramid_steps;

                    // PnL dla headera
                    document.getElementById('position-pnl-percent').textContent = `${data.pnl.percent.toFixed(2)}%`;
                    const pnlPercentElement = document.getElementById('position-pnl-percent');
                    pnlPercentElement.classList.remove('pnl-positive', 'pnl-negative', 'pnl-zero');
                    if (data.pnl.percent > 0) pnlPercentElement.classList.add('pnl-positive');
                    else if (data.pnl.percent < 0) pnlPercentElement.classList.add('pnl-negative');
                    else pnlPercentElement.classList.add('pnl-zero');

                    // PnL dla zakładki Bieżąca Pozycja
                    document.getElementById('position-pnl-value').textContent = `${data.pnl.value.toFixed(2)} ${data.quote_asset}`;
                    document.getElementById('position-pnl-percent-detail').textContent = `${data.pnl.percent.toFixed(2)}%`;
                    const pnlValueDetailElement = document.getElementById('position-pnl-value');
                    const pnlPercentDetailElement = document.getElementById('position-pnl-percent-detail');
                    pnlValueDetailElement.classList.remove('positive', 'negative');
                    pnlPercentDetailElement.classList.remove('positive', 'negative');
                    if (data.pnl.value > 0) {
                        pnlValueDetailElement.classList.add('positive');
                        pnlPercentDetailElement.classList.add('positive');
                    } else if (data.pnl.value < 0) {
                        pnlValueDetailElement.classList.add('negative');
                        pnlPercentDetailElement.classList.add('negative');
                    }

                    document.getElementById('close-position-button').style.display = 'block';

                    // Cooldown re-entry
                    document.getElementById('position-reentry-cooldown').textContent = '--'; // Resetuj, bo jesteśmy w pozycji
                } else {
                    botStatusElement.classList.add('not-in-position');
                    document.getElementById('current-position-status').textContent = 'Brak pozycji';
                    document.getElementById('current-position-status').classList.remove('in-position');
                    document.getElementById('current-position-status').classList.add('not-in-position');

                    document.getElementById('position-symbol').textContent = '--';
                    document.getElementById('position-side').textContent = '--';
                    document.getElementById('position-quantity').textContent = '--';
                    document.getElementById('position-entry-price').textContent = '--';
                    document.getElementById('position-entry-time').textContent = '--';
                    document.getElementById('position-pnl-value').textContent = '--';
                    document.getElementById('position-pnl-percent-detail').textContent = '--';
                    document.getElementById('position-reentry-count').textContent = `${data.reentry_info.count} / ${data.reentry_info.max_count}`;
                    document.getElementById('position-pyramid-steps').textContent = '--';

                    document.getElementById('position-pnl-percent').textContent = '--';
                    const pnlPercentElement = document.getElementById('position-pnl-percent');
                    pnlPercentElement.classList.remove('pnl-positive', 'pnl-negative', 'pnl-zero');


                    document.getElementById('close-position-button').style.display = 'none';

                    if (data.reentry_info.cooldown_remaining > 0) {
                        const minutes = Math.floor(data.reentry_info.cooldown_remaining / 60);
                        const seconds = Math.floor(data.reentry_info.cooldown_remaining % 60);
                        document.getElementById('position-reentry-cooldown').textContent = `${minutes}m ${seconds}s`;
                    } else {
                        document.getElementById('position-reentry-cooldown').textContent = 'Gotowy';
                    }
                }

                if (data.current_price) {
                    document.getElementById('current-price').textContent = parseFloat(data.current_price).toFixed(4);
                } else {
                    document.getElementById('current-price').textContent = '--';
                }

            } catch (error) {
                console.error('Błąd ładowania statusu bota:', error);
                document.getElementById('bot-status').textContent = 'Błąd ładowania statusu';
                document.getElementById('bot-status').classList.add('error');
                document.getElementById('available-balance').textContent = '0.00';
                document.getElementById('current-price').textContent = '--';
                document.getElementById('position-pnl-percent').textContent = '--';
                showMessage('config-message', 'error', 'Nie udało się połączyć z API Binance. Sprawdź klucze i połączenie.');
            }
        }

        async function updateStatsDisplay() {
            try {
                const response = await fetch('/stats_data');
                const data = await response.json();
                const stats = data.stats;

                document.getElementById('total-pnl').textContent = stats.total_pnl.toFixed(2);
                if (stats.total_pnl > 0) document.getElementById('total-pnl').className = 'stat-value positive';
                else if (stats.total_pnl < 0) document.getElementById('total-pnl').className = 'stat-value negative';
                else document.getElementById('total-pnl').className = 'stat-value zero';

                document.getElementById('total-positions').textContent = stats.total_positions;
                document.getElementById('successful-positions').textContent = stats.successful_positions;
                document.getElementById('win-rate').textContent = `${stats.win_rate.toFixed(2)}%`;
                document.getElementById('avg-pnl-per-trade').textContent = stats.avg_pnl_per_trade.toFixed(2);
                if (stats.avg_pnl_per_trade > 0) document.getElementById('avg-pnl-per-trade').className = 'stat-value positive';
                else if (stats.avg_pnl_per_trade < 0) document.getElementById('avg-pnl-per-trade').className = 'stat-value negative';
                else document.getElementById('avg-pnl-per-trade').className = 'stat-value zero';

                document.getElementById('max-profit-trade').textContent = stats.max_profit_trade.toFixed(2);
                document.getElementById('max-loss-trade').textContent = stats.max_loss_trade.toFixed(2);

            } catch (error) {
                console.error('Błąd ładowania statystyk:', error);
                // Możesz ustawić domyślne wartości lub komunikat o błędzie na interfejsie
            }
        }


        document.getElementById('config-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const plainFormData = Object.fromEntries(formData.entries());

            // Checkbox'y są specjalnie traktowane, jeśli nie są zaznaczone, nie są wysyłane z FormData
            plainFormData.reentry_enabled = document.getElementById('reentry_enabled').checked;
            plainFormData.pyramid_enabled = document.getElementById('pyramid_enabled').checked;

            try {
                const response = await fetch('/save_config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(plainFormData).toString()
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage('config-message', 'success', data.message);
                    // Po zapisaniu konfiguracji, odśwież dane rynkowe, aby symbol mógł się zaktualizować
                    loadMarketData();
                    updateStatusDisplay(); // Odśwież status, aby zobaczyć wpływ zmian
                } else {
                    showMessage('config-message', 'error', data.message);
                }
            } catch (error) {
                console.error('Błąd podczas zapisywania konfiguracji:', error);
                showMessage('config-message', 'error', 'Nie udało się zapisać konfiguracji. Błąd sieci lub serwera.');
            }
        });

        document.getElementById('close-position-button').addEventListener('click', async function() {
            if (confirm('Jesteś pewien, że chcesz awaryjnie zamknąć pozycję?')) {
                try {
                    const response = await fetch('/close_position_emergency', {
                        method: 'POST'
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessage('close-position-message', 'success', data.message);
                        updateStatusDisplay();
                    } else {
                        showMessage('close-position-message', 'error', data.message);
                    }
                } catch (error) {
                    console.error('Błąd podczas awaryjnego zamykania pozycji:', error);
                    showMessage('close-position-message', 'error', 'Nie udało się zamknąć pozycji. Błąd sieci lub serwera.');
                }
            }
        });

        function showMessage(elementId, type, message) {
            const messageBox = document.getElementById(elementId);
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`; // Zastąp stare klasy nowymi
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 5000); // Ukryj po 5 sekundach
        }

        // Obsługa zmiany strategii wyjścia
        document.getElementById('exit_strategy').addEventListener('change', function() {
            const tpPercentGroup = document.querySelector('label[for="tp_percent"]').closest('.form-group');
            const tsActivationGroup = document.querySelector('label[for="ts_activation_percent"]').closest('.form-group');
            const tsDistanceGroup = document.querySelector('label[for="ts_distance_percent"]').closest('.form-group');

            if (this.value === 'take_profit') {
                tpPercentGroup.style.display = 'flex';
                tsActivationGroup.style.display = 'none';
                tsDistanceGroup.style.display = 'none';
            } else if (this.value === 'trailing_stop') {
                tpPercentGroup.style.display = 'none';
                tsActivationGroup.style.display = 'flex';
                tsDistanceGroup.style.display = 'flex';
            }
        });

        // Wywołaj raz na początku, aby ustawić poprawny stan
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById('exit_strategy').dispatchEvent(new Event('change'));
        });

    </script>
</body>
</html>
