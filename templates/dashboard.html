<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centrum Dowodzenia Kombajnu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #2c3e50; color: #ecf0f1; }
        .card { background-color: #34495e; border: 1px solid #4a627a; }
        .card-header { background-color: #4a627a; color: #ecf0f1; border-bottom: 1px solid #2c3e50; }
        .table { color: #ecf0f1; }
        .table-striped>tbody>tr:nth-of-type(odd)>* { background-color: rgba(255, 255, 255, 0.05); }
        .status-ok { color: #2ecc71; }
        .status-in-position { color: #f1c40f; }
        .status-error { color: #e74c3c; }
        .form-control, .form-select { background-color: #4a627a; color: #ecf0f1; border-color: #2c3e50; }
        .form-control:focus, .form-select:focus { background-color: #4a627a; color: #ecf0f1; border-color: #3498db; box-shadow: none; }
        .btn-primary { background-color: #3498db; border-color: #3498db; }
        .btn-danger { background-color: #e74c3c; border-color: #e74c3c; }
        .btn-warning { background-color: #f39c12; border-color: #f39c12; }
        .pnl-positive { color: #2ecc71; }
        .pnl-negative { color: #e74c3c; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">ü§ñ Centrum Dowodzenia "Kombajnu"</h1>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <div class="row">
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header">Status Systemu</div>
                    <div class="card-body">
                        <h5 id="status-text">≈ÅADOWANIE...</h5>
                        <p class="mb-1"><strong>Balans:</strong> <span id="balance">...</span> <span id="quote_asset"></span></p>
                        <hr>
                        <div id="position-details" style="display: none;">
                            <p class="mb-1"><strong>Strona:</strong> <span id="pos-side"></span></p>
                            <p class="mb-1"><strong>Cena Wej≈õcia:</strong> <span id="pos-entry-price"></span></p>
                            <p class="mb-1"><strong>Ilo≈õƒá:</strong> <span id="pos-quantity"></span> <span id="base_asset"></span></p>
                            <p class="mb-1"><strong>Aktualna Cena:</strong> <span id="pos-current-price"></span></p>
                            <p class="mb-1"><strong>PnL:</strong> <span id="pos-pnl-value"></span> (<span id="pos-pnl-percent"></span>)</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                 <div class="card mb-4">
                    <div class="card-header">Statystyki Bojowe</div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col"><strong>Total PnL:</strong><br>{{ "%.2f"|format(stats.total_pnl) }} {{ config.quote_asset }}</div>
                            <div class="col"><strong>Winrate:</strong><br>{{ "%.2f"|format(stats.winrate) }}%</div>
                            <div class="col"><strong>Ilo≈õƒá:</strong><br>{{ stats.total_trades }}</div>
                            <div class="col"><strong>Najlepsza:</strong><br>{{ "%.2f"|format(stats.best_trade) }}</div>
                            <div class="col"><strong>Najgorsza:</strong><br>{{ "%.2f"|format(stats.worst_trade) }}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">Konfiguracja Taktyczna</div>
                    <div class="card-body">
                        <form action="{{ url_for('save_config_route') }}" method="post">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="trade_symbol" class="form-label">Para Handlowa</label>
                                    <select class="form-select" id="trade_symbol" name="trade_symbol">
                                        <option value="{{ config.trade_symbol }}" selected>{{ config.trade_symbol }}</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="position_size_percent" class="form-label">Wielko≈õƒá Pozycji (%)</label>
                                    <input type="number" step="0.1" class="form-control" id="position_size_percent" name="position_size_percent" value="{{ config.position_size_percent }}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="sl_percent" class="form-label">Stop Loss (%)</label>
                                    <input type="number" step="0.1" class="form-control" id="sl_percent" name="sl_percent" value="{{ config.sl_percent }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Strategia Wyj≈õcia</label>
                                    <div>
                                        <input type="radio" class="form-check-input" id="strat_tp" name="exit_strategy" value="take_profit" {% if config.exit_strategy == 'take_profit' %}checked{% endif %}>
                                        <label for="strat_tp">Take Profit</label>
                                        <input type="radio" class="form-check-input ms-3" id="strat_ts" name="exit_strategy" value="trailing_stop" {% if config.exit_strategy == 'trailing_stop' %}checked{% endif %}>
                                        <label for="strat_ts">Trailing Stop</label>
                                    </div>
                                </div>
                            </div>
                            <div id="tp_settings" class="mb-3">
                                <label for="tp_percent" class="form-label">Take Profit (%)</label>
                                <input type="number" step="0.1" class="form-control" id="tp_percent" name="tp_percent" value="{{ config.get('tp_percent', 5.0) }}">
                            </div>
                            <div id="ts_settings" class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="ts_activation_percent" class="form-label">Aktywacja Trailing Stop (%)</label>
                                    <input type="number" step="0.1" class="form-control" id="ts_activation_percent" name="ts_activation_percent" value="{{ config.get('ts_activation_percent', 2.0) }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="ts_distance_percent" class="form-label">Dystans Trailing Stop (%)</label>
                                    <input type="number" step="0.1" class="form-control" id="ts_distance_percent" name="ts_distance_percent" value="{{ config.get('ts_distance_percent', 1.0) }}">
                                </div>
                            </div>
                             <hr>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="reentry_enabled" name="reentry_enabled" {% if config.reentry_enabled %}checked{% endif %}>
                                <label class="form-check-label" for="reentry_enabled">Ognisty Podmuch (Re-entry po TP)</label>
                            </div>
                             <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="reentry_max_count" class="form-label">Max. Ilo≈õƒá Re-entry</label>
                                    <input type="number" class="form-control" id="reentry_max_count" name="reentry_max_count" value="{{ config.reentry_max_count }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="reentry_cooldown_seconds" class="form-label">Cooldown Re-entry (s)</label>
                                    <input type="number" class="form-control" id="reentry_cooldown_seconds" name="reentry_cooldown_seconds" value="{{ config.reentry_cooldown_seconds }}">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Zapisz i Restartuj</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card mb-3">
                    <div class="card-header">Szybkie Akcje</div>
                     <div class="card-body text-center">
                        <form action="{{ url_for('close_position_emergency') }}" method="post" onsubmit="return confirm('Czy na pewno chcesz awaryjnie zamknƒÖƒá pozycjƒô?');" class="d-inline">
                            <button type="submit" class="btn btn-warning">Zamknij Pozycjƒô</button>
                        </form>
                    </div>
                </div>
                <div class="card bg-danger text-white mb-3">
                    <div class="card-header">Strefa Awaryjna</div>
                    <div class="card-body text-center">
                        <p class="small">U≈ºyj TYLKO, gdy bot siƒô zablokuje.</p>
                        <form action="{{ url_for('emergency_reset') }}" method="post" onsubmit="return confirm('JESTE≈ö PEWIEN? To usunie plik stanu i zrestartuje bota!');" class="d-inline">
                            <button type="submit" class="btn btn-light">Awaryjny Reset Stanu</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Kronika Bitew</div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Data Wyj≈õcia</th>
                                <th>Para</th>
                                <th>Strona</th>
                                <th>Cena Wej≈õcia</th>
                                <th>Cena Wyj≈õcia</th>
                                <th>Ilo≈õƒá</th>
                                <th>PnL</th>
                                <th>Pow√≥d</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trade in history %}
                            <tr>
                                <td>{{ trade.exit_timestamp.replace('T', ' ').split('.')[0] }}</td>
                                <td>{{ trade.symbol }}</td>
                                <td class="{{ 'text-success' if trade.side == 'long' else 'text-danger' }}">{{ trade.side.upper() }}</td>
                                <td>{{ "%.4f"|format(trade.entry_price|float) }}</td>
                                <td>{{ "%.4f"|format(trade.exit_price|float) }}</td>
                                <td>{{ trade.quantity }}</td>
                                <td class="{{ 'pnl-positive' if trade.pnl|float >= 0 else 'pnl-negative' }}">{{ "%.2f"|format(trade.pnl|float) }}</td>
                                <td>{{ trade.exit_reason }}</td>
                            </tr>
                            {% else %}
                            <tr><td colspan="8" class="text-center">Brak historii transakcji.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        function updateStatus() {
            fetch('/status')
                .then(response => response.json())
                .then(data => {
                    const statusTextEl = document.getElementById('status-text');
                    if (data.in_position) {
                        statusTextEl.textContent = 'W POZYCJI';
                        statusTextEl.className = 'status-in-position';
                        document.getElementById('position-details').style.display = 'block';
                        document.getElementById('pos-side').textContent = data.state.side.toUpperCase();
                        document.getElementById('pos-entry-price').textContent = parseFloat(data.state.entry_price).toFixed(4);
                        document.getElementById('pos-quantity').textContent = parseFloat(data.state.quantity).toFixed(6);
                        document.getElementById('base_asset').textContent = data.base_asset;
                        if(data.pnl && typeof data.pnl.value === 'number') {
                            document.getElementById('pos-current-price').textContent = data.current_price.toFixed(4);
                            const pnlValueEl = document.getElementById('pos-pnl-value');
                            const pnlPercentEl = document.getElementById('pos-pnl-percent');
                            pnlValueEl.textContent = data.pnl.value.toFixed(2) + ' ' + data.quote_asset;
                            pnlPercentEl.textContent = data.pnl.percent.toFixed(2) + '%';
                            pnlValueEl.className = data.pnl.value >= 0 ? 'pnl-positive' : 'pnl-negative';
                            pnlPercentEl.className = data.pnl.percent >= 0 ? 'pnl-positive' : 'pnl-negative';
                        } else {
                           document.getElementById('pos-current-price').textContent = '...';
                        }
                    } else {
                        statusTextEl.textContent = 'OCZEKIWANIE';
                        statusTextEl.className = 'status-ok';
                        document.getElementById('position-details').style.display = 'none';
                    }
                    document.getElementById('balance').textContent = data.balance;
                    document.getElementById('quote_asset').textContent = data.quote_asset;
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    const statusTextEl = document.getElementById('status-text');
                    statusTextEl.textContent = 'B≈ÅƒÑD PO≈ÅƒÑCZENIA';
                    statusTextEl.className = 'status-error';
                });
        }
        
        function toggleExitStrategy() {
            const tpSettings = document.getElementById('tp_settings');
            const tsSettings = document.getElementById('ts_settings');
            if (document.getElementById('strat_tp').checked) {
                tpSettings.style.display = 'block';
                tsSettings.style.display = 'none';
            } else {
                tpSettings.style.display = 'none';
                tsSettings.style.display = 'flex'; // U≈ºywamy flex, bo to jest 'row'
            }
        }

        function populateMarketData() {
            fetch('/market_data')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('trade_symbol');
                    const currentSymbol = "{{ config.trade_symbol }}";
                    data.usdc_pairs.forEach(pair => {
                        if (pair !== currentSymbol) {
                            const option = document.createElement('option');
                            option.value = pair;
                            option.textContent = pair;
                            select.appendChild(option);
                        }
                    });
                })
                .catch(error => console.error('Error fetching market data:', error));
        }

        document.querySelectorAll('input[name="exit_strategy"]').forEach(radio => {
            radio.addEventListener('change', toggleExitStrategy);
        });

        document.addEventListener('DOMContentLoaded', () => {
            updateStatus();
            toggleExitStrategy();
            populateMarketData();
        });
        setInterval(updateStatus, 5000);
    </script>
</body>
</html>

